# NBD 프로토콜

## 문서를 읽기 전에

1. 공식 문서 상에서는 `Oldstyle` 과 `Newstyle` Neogotiation 으로 나누어서 설명하는
경우가 있는데, 본 문서에서는 `Newstyle` 만을 설명함.

## 컨벤션

* `S`: 서버 측에서 보내는 메시지.
* `C`: 클라이언트 측에서 보내는 메시지.
* 그 외에 "MUST", "MUST NOT", "REQUIRED", ... 키워드를 사용하는 경우가 있음.

## Protocol Phases

### 연결 시 사용할 포트 번호

* IANA 에서 예약한 포트 `10809` 포트를 사용하여 연결되어야 함.
* Newstyle 포트에서 Oldstyle Neogitation 을 사용할 수 없도록 하여야 함.
* 디버깅을 할 때에는 다른 포트를 통해서 연결할 수 있지만 실쩨 상용으로 돌릴 경우
에는 해당 `10809` 포트를 사용해야 함.

### 연결 (Handshake)

> Newstyle 연결 방식에서는, 다음의 흐름을 통해서 연결을 진행함.

* `S`: 64 비트, `0x4e42444d41474943` (ASCII: `NBDMAGIC`)
* `S`: 64 비트, `0x49484156454F5054` (ASCII: `IHAVEOPT`)
* `S`: 16 비트, 연결에 필요한 Flag 들.
* `C`: 32 비트, Client 측에서 보내주는 Flag 들.

> 클라이언트 측에서는 정의되지 않은 Flag 를 무시해야 하며, 서버 측에서는
> 클라리언트 측에서 정의되지 않은 Flag 를 받았을 경우, 연결을 종료할 수 있어야 함.

> 만약 클라이언트 측에서 한개를 포함한 여러가지의 옵션을 보내고자 하는 경우
> 다음의 방식을 통해서 옵션 Flag 를 보낼 수 있다.

* `C`: 64 비트, `0x49484156454F5054` (ASCII: `IHAVEOPT`)
* `C`: 32 비트, 옵션
* `C`: 32 비트, 옵션 데이터의 크기 (unsigned, length)
* `C`: 정의한 길이 내에서 보낼 수 있는 모든 데이터
